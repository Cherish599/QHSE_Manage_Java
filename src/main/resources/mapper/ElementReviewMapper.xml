<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wlhse.dao.ElementReviewDao">

    <select id="query" parameterType="com.wlhse.dto.inDto.ElementReviewDto"
            resultType="com.wlhse.dto.outDto.QHSECompanyYearManagerSysElementDto">
        select * from qhse_companyyearmanagersyselement
        <where>
            <if test="companyCode !=null and companyCode!=''">
                AND companyCode like concat(#{companyCode},'%')
            </if>
            <if test="year != null and year  != ''">
                AND year=#{year}
            </if>
            and qHSE_CompanyYearManagerSysElementTable_ID in
             (select qHSE_CompanyYearManagerSysElementTable_ID
            from qhse_companyyearmanagersyselementtable where checkStaffID=#{checkStaffID}) and status="未审核"
        </where>
    </select>

    <select id="queryS" parameterType="com.wlhse.dto.inDto.ElementReviewDto"
            resultType="com.wlhse.dto.outDto.QHSECompanyYearManagerSysElementDto">
        select * from qhse_companyyearmanagersyselement
        <where>
            <if test="companyCode !=null and companyCode!=''">
                AND companyCode like concat(#{companyCode},'%')
            </if>
        <if test="year != null and year  != ''">
            AND year=#{year}
        </if>
        and qHSE_CompanyYearManagerSysElementTable_ID in
        (select qHSE_CompanyYearManagerSysElementTable_ID
        from qhse_companyyearmanagersyselementtable where approverStaffID=#{approverStaffID})and status="未批准"
    </where>
    </select>

    <update id="update" parameterType="com.wlhse.dto.inDto.ElementReviewDto">
        update qhse_companyyearmanagersyselement
        set status=#{status}
        where qHSE_CompanyYearManagerSysElement_ID=#{qHSE_CompanyYearManagerSysElement_ID}
    </update>

    <sql id = "element_evidence_key">
        t1.qHSE_CompanyYearManagerSysElementEvidence_ID,
        qHSE_CompanyYearManagerSysElement_ID,
        code,
        evidenceDescription,
        checkStaffID,
        checkStaffName,
        approverStaffID,
        approverStaffName,
        qHSE_CompanyYearManagerSysElementEvidenceAttach_ID,
        attachDescrption,
        attach,
        uploadTime
    </sql>

    <select id="queryAll" parameterType="com.wlhse.dto.outDto.QhseEvidenceAttatchDto"
            resultType="com.wlhse.dto.outDto.QhseEvidenceAttatchDto">
        select
        <include refid="element_evidence_key"/>
         from qhse_companyyearmanagersyselementevidence t1,qhse_companyyearmanagersyselementevidenceattach t2
        where t1.QHSE_CompanyYearManagerSysElementEvidence_ID=t2.QHSE_CompanyYearManagerSysElementEvidence_ID
        and t1.QHSE_CompanyYearManagerSysElement_ID=#{qHSE_CompanyYearManagerSysElement_ID}
    </select>

    <select id="queryParent" parameterType="java.lang.String"
            resultType="com.wlhse.dto.outDto.QHSECompanyYearManagerSysElementDto">
        select * from qhse_companyyearmanagersyselement where  code=#{code}
    </select>

</mapper>